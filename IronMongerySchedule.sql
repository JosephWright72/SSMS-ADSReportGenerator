 DECLARE @PROJECTID INT DECLARE @DOORFILTER INT SET @PROJECTID = 30069 SET @DOORFILTER = 2 SET ARITHABORT ON IF @DOORFILTER=2  
SELECT  '2' AS Filter, HW.SETNAME,'\\10.244.166.10\c$\Tomcat 8.0\webapps\AAOS\res\ASSA ABLOY\CatalogCuts\' + CASE WHEN LEFT([FileName], 1) = '\' THEN RIGHT([FileName], LEN([FileName])-1) ELSE [FileName] END as Image, CASE WHEN Len(HW.PRICE)=0 THEN '0' ELSE HW.PRICE END AS totSetItemPrice, HW.PRODUCT, CASE WHEN HW.QTY = '' THEN 0 ELSE ISNULL(HW.QTY,0) END AS QTY, HW.DESCRIPTION, HW.TYPEDESCRIPTION, AP.PROJECTNAME, AP.ID ProjectReference, CASE WHEN AP.OriginalProjectID IS NULL or AP.OriginalProjectID <> '0'  THEN CAST(AP.OriginalProjectID AS nvarchar(max))  +  '-'  +  CAST(AP.RevisionNumber AS nvarchar(max))  ELSE CAST(AP.ID AS nvarchar(max)) END as NewProjID,  CASE WHEN Len(PH.PRICE)=0 THEN '0' ELSE PH.PRICE END AS singlePrice, PH.UOM, (ACS.FIRSTNAME+' ' +ACS.LASTNAME) as SalesRep, ACS.EMAIL as Email,  ACS.firstname + ' ' + ACS.lastname ProjectOwner,  CS.firstname + ' ' + CS.lastname SpecConsult,  ACS.Email AS PrjOwnEmail , CS.Email AS SpecConEmail , ACS.Phone PrjOwnNumber,  CS.Phone SpecConNumber,  ACS.Title PrjOwnTitle,  CS.Title SpecConTitle,  HW.Finish as Finish,ISNULL(DOORS.QTY, 0) AS TotDoors, TOTALS.PRICE TotSetPrice, CASE     WHEN Day(Getdate()) IN ( 1, 21, 31 )         THEN CONVERT(VARCHAR, Day(Getdate())) + 'st '    WHEN Day(Getdate()) IN ( 2, 22 )         THEN CONVERT(VARCHAR, Day(Getdate())) + 'nd '    WHEN Day(Getdate()) IN ( 3, 23 )         THEN CONVERT(VARCHAR, Day(Getdate())) + 'rd ' ELSE     CONVERT(VARCHAR, Day(Getdate())) + 'th ' END+Datename(MONTH, Getdate())+' '+CONVERT(VARCHAR, Year(Getdate())) TodaysDateEN, getdate() TodaysDate, ISNULL(DOORS.LIST, 'N/A') AS Mark, CASE WHEN Len(HW.SETNOTES)>0 THEN (HW.SETNAME+' : ' +Replace(Replace(HW.SETNOTES, Char(13), ' '), Char(10), ' ')) ELSE NULL END AS SetNotes  FROM   AAOSPROJECTHARDWARE PH RIGHT OUTER JOIN AAOSHWSETS HW ON PH.ITEM=HW.PRODUCT  LEFT OUTER JOIN AAOSPROJECTS AP ON HW.PROJECTID=AP.ID  LEFT OUTER JOIN AAOSCONSULTANTS ACS ON AP.ARCHCONSULTANT=ACS.ID  left outer join AAOSConsultants CS on AP.consultant = CS.id LEFT OUTER JOIN (SELECT PROJECTID,SETNAME,Sum(Cast (QTY AS INT)) Qty,Sum(Cast(CASE WHEN Len(AAOSHWSETS.PRICE)=0 THEN '0'                     ELSE AAOSHWSETS.PRICE                     END AS DECIMAL(18, 2))*Cast (QTY AS INT)) Price                     FROM   AAOSHWSETS                     WHERE  AAOSHWSETS.PROJECTID=@PROJECTID                     GROUP  BY AAOSHWSETS.PROJECTID,SETNAME) TOTALS                    ON TOTALS.PROJECTID=HW.PROJECTID AND TOTALS.SETNAME=HW.SETNAME  LEFT OUTER JOIN (SELECT PROJECTID,HWSET,Sum(QTY) Qty,Stuff((SELECT ', '+Cast(MARK AS VARCHAR(250)) [text()]                     FROM   AAOSDOORS                     WHERE  HWSET=T.HWSET AND                     PROJECTID=@PROJECTID                     FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, ' ') List                     FROM   AAOSDOORS T                     WHERE  PROJECTID=@PROJECTID AND                     (Charindex('deleted', CHANGELOG)<1)                     GROUP  BY PROJECTID,HWSET) DOORS                    ON DOORS.HWSET=HW.SETNAME AND DOORS.PROJECTID=HW.PROJECTID  LEFT OUTER JOIN ( SELECT [Description], MIN(x.ImageID) AS ImageID, ProjectID FROM AAOSProjectHardware APH INNER JOIN ( SELECT A.ID, Split.a.value('.', 'VARCHAR(MAX)') AS ImageID  FROM  ( SELECT ID,  CAST ('<M>' + REPLACE([imageids], ',', '</M><M>') + '</M>' AS XML) AS String FROM  AAOSProjectHardware WHERE ProjectID = @ProjectID) AS A CROSS APPLY String.nodes ('/M') AS Split(a) WHERE ISNULL(Split.a.value('.', 'VARCHAR(MAX)'),'') <> '' UNION SELECT ID,ImageIDs FROM AAOSProjectHardware where ProjectID = @ProjectID AND ISNULL(ImageIDs,'') ='' ) x INNER JOIN (SELECT Image_id, [Filename] FROM AAOS.dbo.images img WHERE (NOT (UPPER([Filename]) LIKE '%.PDF') OR ISNULL([Filename],'') = '')) img ON  x.ImageID = img.Image_id ON x.ID = APH.ID  GROUP BY [Description], ProjectID ) APH ON  CAST(HW.[DESCRIPTION] AS VARBINARY(MAX)) =  CAST(APH.[description] AS VARBINARY(MAX)) AND APH.ProjectID=HW.PROJECTID  LEFT OUTER JOIN AAOS.dbo.images img ON APH.ImageID= img.Image_ID   WHERE  (HW.PROJECTID=@PROJECTID)   AND ( AP.ID=@PROJECTID)  AND (PH.PROJECTID=@PROJECTID)   ORDER  BY HW.SETNAME,PH.DHI  ELSE BEGIN     IF @DOORFILTER=0  SELECT  '1' AS Filter, HW.SETNAME,'\\10.244.166.10\c$\Tomcat 8.0\webapps\AAOS\res\ASSA ABLOY\CatalogCuts\' + CASE WHEN LEFT([FileName], 1) = '\' THEN RIGHT([FileName], LEN([FileName])-1) ELSE [FileName] END as Image, CASE WHEN Len(HW.PRICE)=0 THEN '0' ELSE HW.PRICE END AS totSetItemPrice, HW.PRODUCT, CASE WHEN HW.QTY = '' THEN 0 ELSE ISNULL(HW.QTY,0) END AS QTY, HW.DESCRIPTION, HW.TYPEDESCRIPTION, AP.PROJECTNAME, AP.ID ProjectReference, CASE WHEN AP.OriginalProjectID IS NULL or AP.OriginalProjectID <> '0'  THEN CAST(AP.OriginalProjectID AS nvarchar(max))  +  '-'  +  CAST(AP.RevisionNumber AS nvarchar(max))  ELSE CAST(AP.ID AS nvarchar(max)) END as NewProjID,  CASE WHEN Len(PH.PRICE)=0 THEN '0' ELSE PH.PRICE END AS singlePrice, PH.UOM, (ACS.FIRSTNAME+' ' +ACS.LASTNAME) as SalesRep, ACS.EMAIL as Email,  ACS.firstname + ' ' + ACS.lastname ProjectOwner,  CS.firstname + ' ' + CS.lastname SpecConsult,  ACS.Email AS PrjOwnEmail , CS.Email AS SpecConEmail , ACS.Phone PrjOwnNumber,  CS.Phone SpecConNumber,  ACS.Title PrjOwnTitle,  CS.Title SpecConTitle,  HW.Finish as Finish,ISNULL(DOORS.QTY, 0) AS TotDoors, TOTALS.PRICE TotSetPrice, CASE     WHEN Day(Getdate()) IN ( 1, 21, 31 )         THEN CONVERT(VARCHAR, Day(Getdate())) + 'st '    WHEN Day(Getdate()) IN ( 2, 22 )         THEN CONVERT(VARCHAR, Day(Getdate())) + 'nd '    WHEN Day(Getdate()) IN ( 3, 23 )         THEN CONVERT(VARCHAR, Day(Getdate())) + 'rd ' ELSE     CONVERT(VARCHAR, Day(Getdate())) + 'th ' END+Datename(MONTH, Getdate())+' '+CONVERT(VARCHAR, Year(Getdate())) TodaysDateEN, getdate() TodaysDate, ISNULL(DOORS.LIST, 'N/A') AS Mark, CASE WHEN Len(HW.SETNOTES)>0 THEN (HW.SETNAME+' : ' +Replace(Replace(HW.SETNOTES, Char(13), ' '), Char(10), ' ')) ELSE NULL END AS SetNotes  FROM   AAOSPROJECTHARDWARE PH RIGHT OUTER JOIN AAOSHWSETS HW ON PH.ITEM=HW.PRODUCT  LEFT OUTER JOIN AAOSPROJECTS AP ON HW.PROJECTID=AP.ID  LEFT OUTER JOIN AAOSCONSULTANTS ACS ON AP.ARCHCONSULTANT=ACS.ID  left outer join AAOSConsultants CS on AP.consultant = CS.id LEFT OUTER JOIN (SELECT PROJECTID,SETNAME,Sum(Cast (QTY AS INT)) Qty,Sum(Cast(CASE WHEN Len(AAOSHWSETS.PRICE)=0 THEN '0'                     ELSE AAOSHWSETS.PRICE                     END AS DECIMAL(18, 2))*Cast (QTY AS INT)) Price                     FROM   AAOSHWSETS                     WHERE  AAOSHWSETS.PROJECTID=@PROJECTID                     GROUP  BY AAOSHWSETS.PROJECTID,SETNAME) TOTALS                    ON TOTALS.PROJECTID=HW.PROJECTID AND TOTALS.SETNAME=HW.SETNAME  LEFT OUTER JOIN (SELECT PROJECTID,HWSET,Sum(QTY) Qty,Stuff((SELECT ', '+Cast(MARK AS VARCHAR(250)) [text()]                     FROM   AAOSDOORS                     WHERE  HWSET=T.HWSET AND                     PROJECTID=@PROJECTID                     FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, ' ') List                     FROM   AAOSDOORS T                     WHERE  PROJECTID=@PROJECTID AND                     (Charindex('deleted', CHANGELOG)<1)                     GROUP  BY PROJECTID,HWSET) DOORS                    ON DOORS.HWSET=HW.SETNAME AND DOORS.PROJECTID=HW.PROJECTID  LEFT OUTER JOIN ( SELECT [Description], MIN(x.ImageID) AS ImageID, ProjectID FROM AAOSProjectHardware APH INNER JOIN ( SELECT A.ID, Split.a.value('.', 'VARCHAR(MAX)') AS ImageID  FROM  ( SELECT ID,  CAST ('<M>' + REPLACE([imageids], ',', '</M><M>') + '</M>' AS XML) AS String FROM  AAOSProjectHardware WHERE ProjectID = @ProjectID) AS A CROSS APPLY String.nodes ('/M') AS Split(a) WHERE ISNULL(Split.a.value('.', 'VARCHAR(MAX)'),'') <> '' UNION SELECT ID,ImageIDs FROM AAOSProjectHardware where ProjectID = @ProjectID AND ISNULL(ImageIDs,'') ='' ) x INNER JOIN (SELECT Image_id, [Filename] FROM AAOS.dbo.images img WHERE (NOT (UPPER([Filename]) LIKE '%.PDF') OR ISNULL([Filename],'') = '')) img ON  x.ImageID = img.Image_id ON x.ID = APH.ID  GROUP BY [Description], ProjectID ) APH ON  CAST(HW.[DESCRIPTION] AS VARBINARY(MAX)) =  CAST(APH.[description] AS VARBINARY(MAX)) AND APH.ProjectID=HW.PROJECTID  LEFT OUTER JOIN AAOS.dbo.images img ON APH.ImageID= img.Image_ID       WHERE  (HW.PROJECTID=@PROJECTID) AND       (AP.ID=@PROJECTID) AND       (PH.PROJECTID=@PROJECTID) AND       ISNULL(DOORS.QTY, 0)!=0       ORDER  BY HW.SETNAME,PH.DHI     ELSE  SELECT  '0' AS Filter, HW.SETNAME,'\\10.244.166.10\c$\Tomcat 8.0\webapps\AAOS\res\ASSA ABLOY\CatalogCuts\' + CASE WHEN LEFT([FileName], 1) = '\' THEN RIGHT([FileName], LEN([FileName])-1) ELSE [FileName] END as Image, CASE WHEN Len(HW.PRICE)=0 THEN '0' ELSE HW.PRICE END AS totSetItemPrice, HW.PRODUCT, CASE WHEN HW.QTY = '' THEN 0 ELSE ISNULL(HW.QTY,0) END AS QTY, HW.DESCRIPTION, HW.TYPEDESCRIPTION, AP.PROJECTNAME, AP.ID ProjectReference, CASE WHEN AP.OriginalProjectID IS NULL or AP.OriginalProjectID <> '0'  THEN CAST(AP.OriginalProjectID AS nvarchar(max))  +  '-'  +  CAST(AP.RevisionNumber AS nvarchar(max))  ELSE CAST(AP.ID AS nvarchar(max)) END as NewProjID,  CASE WHEN Len(PH.PRICE)=0 THEN '0' ELSE PH.PRICE END AS singlePrice, PH.UOM, (ACS.FIRSTNAME+' ' +ACS.LASTNAME) as SalesRep, ACS.EMAIL as Email,  ACS.firstname + ' ' + ACS.lastname ProjectOwner,  CS.firstname + ' ' + CS.lastname SpecConsult,  ACS.Email AS PrjOwnEmail , CS.Email AS SpecConEmail , ACS.Phone PrjOwnNumber,  CS.Phone SpecConNumber,  ACS.Title PrjOwnTitle,  CS.Title SpecConTitle,  HW.Finish as Finish,ISNULL(DOORS.QTY, 0) AS TotDoors, TOTALS.PRICE TotSetPrice, CASE     WHEN Day(Getdate()) IN ( 1, 21, 31 )         THEN CONVERT(VARCHAR, Day(Getdate())) + 'st '    WHEN Day(Getdate()) IN ( 2, 22 )         THEN CONVERT(VARCHAR, Day(Getdate())) + 'nd '    WHEN Day(Getdate()) IN ( 3, 23 )         THEN CONVERT(VARCHAR, Day(Getdate())) + 'rd ' ELSE     CONVERT(VARCHAR, Day(Getdate())) + 'th ' END+Datename(MONTH, Getdate())+' '+CONVERT(VARCHAR, Year(Getdate())) TodaysDateEN, getdate() TodaysDate, ISNULL(DOORS.LIST, 'N/A') AS Mark, CASE WHEN Len(HW.SETNOTES)>0 THEN (HW.SETNAME+' : ' +Replace(Replace(HW.SETNOTES, Char(13), ' '), Char(10), ' ')) ELSE NULL END AS SetNotes  FROM   AAOSPROJECTHARDWARE PH RIGHT OUTER JOIN AAOSHWSETS HW ON PH.ITEM=HW.PRODUCT  LEFT OUTER JOIN AAOSPROJECTS AP ON HW.PROJECTID=AP.ID  LEFT OUTER JOIN AAOSCONSULTANTS ACS ON AP.ARCHCONSULTANT=ACS.ID  left outer join AAOSConsultants CS on AP.consultant = CS.id LEFT OUTER JOIN (SELECT PROJECTID,SETNAME,Sum(Cast (QTY AS INT)) Qty,Sum(Cast(CASE WHEN Len(AAOSHWSETS.PRICE)=0 THEN '0'                     ELSE AAOSHWSETS.PRICE                     END AS DECIMAL(18, 2))*Cast (QTY AS INT)) Price                     FROM   AAOSHWSETS                     WHERE  AAOSHWSETS.PROJECTID=@PROJECTID                     GROUP  BY AAOSHWSETS.PROJECTID,SETNAME) TOTALS                    ON TOTALS.PROJECTID=HW.PROJECTID AND TOTALS.SETNAME=HW.SETNAME  LEFT OUTER JOIN (SELECT PROJECTID,HWSET,Sum(QTY) Qty,Stuff((SELECT ', '+Cast(MARK AS VARCHAR(250)) [text()]                     FROM   AAOSDOORS                     WHERE  HWSET=T.HWSET AND                     PROJECTID=@PROJECTID                     FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, ' ') List                     FROM   AAOSDOORS T                     WHERE  PROJECTID=@PROJECTID AND                     (Charindex('deleted', CHANGELOG)<1)                     GROUP  BY PROJECTID,HWSET) DOORS                    ON DOORS.HWSET=HW.SETNAME AND DOORS.PROJECTID=HW.PROJECTID  LEFT OUTER JOIN ( SELECT [Description], MIN(x.ImageID) AS ImageID, ProjectID FROM AAOSProjectHardware APH INNER JOIN ( SELECT A.ID, Split.a.value('.', 'VARCHAR(MAX)') AS ImageID  FROM  ( SELECT ID,  CAST ('<M>' + REPLACE([imageids], ',', '</M><M>') + '</M>' AS XML) AS String FROM  AAOSProjectHardware WHERE ProjectID = @ProjectID) AS A CROSS APPLY String.nodes ('/M') AS Split(a) WHERE ISNULL(Split.a.value('.', 'VARCHAR(MAX)'),'') <> '' UNION SELECT ID,ImageIDs FROM AAOSProjectHardware where ProjectID = @ProjectID AND ISNULL(ImageIDs,'') ='' ) x INNER JOIN (SELECT Image_id, [Filename] FROM AAOS.dbo.images img WHERE (NOT (UPPER([Filename]) LIKE '%.PDF') OR ISNULL([Filename],'') = '')) img ON  x.ImageID = img.Image_id ON x.ID = APH.ID  GROUP BY [Description], ProjectID ) APH ON  CAST(HW.[DESCRIPTION] AS VARBINARY(MAX)) =  CAST(APH.[description] AS VARBINARY(MAX)) AND APH.ProjectID=HW.PROJECTID  LEFT OUTER JOIN AAOS.dbo.images img ON APH.ImageID= img.Image_ID       WHERE  (HW.PROJECTID=@PROJECTID) AND       (AP.ID=@PROJECTID) AND       (PH.PROJECTID=@PROJECTID) AND       ISNULL(DOORS.QTY, 0)=0       ORDER  BY HW.SETNAME,PH.DHI  END 
